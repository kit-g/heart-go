AWSTemplateFormatVersion: "2010-09-09"
Description: "Heart app monitoring dashboards"

Parameters:
  BaseRegion:
    Type: String
    Default: "ca-central-1"
    Description: "Base region for the dashboards"
  MediaDistributionId:
    Type: String
    Description: "CloudFront Distribution ID for the media stack"
  ApiName:
    Type: String
    Description: "Heart API Gateway"
  TableName:
    Type: String
    Description: "Heart DynamoDB Table Name"
    Default: "workouts"


Resources:
  HeartAppDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/Lambda",
                    "Invocations",
                    "FunctionName",
                    "heart-api"],
                  [
                    "...",
                    "heart-images"],
                  [
                    "...",
                    "heart-background"]
                ],
                "region": "${BaseRegion}",
                "stat": "Sum",
                "title": "Lambda Invocations"
              }
            },
            {
              "type": "metric",
              "x": 6,
              "y": 0,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/Lambda",
                    "Errors",
                    "FunctionName",
                    "heart-api"
                  ],
                  [
                    "...",
                    "heart-images"
                  ],
                  [
                    "...",
                    "heart-background"
                  ]
                ],
                "region": "${BaseRegion}",
                "stat": "Sum",
                "title": "Lambda Errors"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/Lambda",
                    "Duration",
                    "FunctionName",
                    "heart-api"
                  ],
                  [
                    "...",
                    "heart-images"],
                  [
                    "...",
                    "heart-background"]
                ],
                "region": "${BaseRegion}",
                "stat": "Average",
                "title": "Lambda Duration"
              }
            },
            {
              "type": "metric",
              "x": 18,
              "y": 0,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/Lambda",
                    "ConcurrentExecutions",
                    "FunctionName",
                    "heart-api"
                  ],
                  [
                    "...",
                    "heart-images"],
                  [
                    "...",
                    "heart-background"
                  ]
                ],
                "region": "${BaseRegion}",
                "stat": "Sum",
                "title": "Lambda Concurrent Executions"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/CloudFront",
                    "Requests",
                    "DistributionId",
                    "${MediaDistributionId}",
                    "Region",
                    "Global"]
                ],
                "region": "us-east-1",
                "stat": "Sum",
                "title": "CloudFront Requests (Media)"
              }
            },
            {
              "type": "metric",
              "x": 6,
              "y": 6,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/CloudFront",
                    "4xxErrorRate",
                    "DistributionId",
                    "${MediaDistributionId}",
                    "Region",
                    "Global"],
                  [
                    ".",
                    "5xxErrorRate",
                    ".",
                    ".",
                    ".",
                    "."]
                ],
                "region": "us-east-1",
                "stat": "Average",
                "title": "CloudFront Error Rates (Media)",
                "yAxis": {
                  "left": {
                    "min": 0,
                    "max": 100
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/CloudFront",
                    "BytesDownloaded",
                    "DistributionId",
                    "${MediaDistributionId}",
                    "Region",
                    "Global"],
                  [
                    ".",
                    "BytesUploaded",
                    ".",
                    ".",
                    ".",
                    "."]
                ],
                "region": "us-east-1",
                "stat": "Sum",
                "title": "CloudFront Data Transfer (Media)"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/ApiGateway",
                    "Count",
                    "ApiName",
                    "${ApiName}"
                  ]
                ],
                "region": "${BaseRegion}",
                "stat": "Sum",
                "title": "API Gateway Requests"
              }
            },
            {
              "type": "metric",
              "x": 6,
              "y": 12,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/ApiGateway",
                    "4XXError",
                    "ApiName",
                    "${ApiName}"
                  ],
                  [
                    ".",
                    "5XXError",
                    ".",
                    "."
                  ]
                ],
                "region": "${BaseRegion}",
                "stat": "Sum",
                "title": "API Gateway Errors"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 12,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/ApiGateway",
                    "IntegrationLatency",
                    "ApiName",
                    "${ApiName}"
                  ],
                  [
                    ".",
                    "Latency",
                    ".",
                    "."
                  ]
                ],
                "region": "${BaseRegion}",
                "stat": "Average",
                "title": "API Gateway Latency"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 18,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/DynamoDB",
                    "SuccessfulRequestLatency",
                    "TableName",
                    "${TableName}",
                    "Operation",
                    "BatchWriteItem"
                  ],
                  [
                    "...",
                    "PutItem"
                  ],
                  [
                    "...",
                    "GetItem"
                  ],
                  [
                    "...",
                    "BatchGetItem"
                  ],
                  [
                    "...",
                    "Query"
                  ],
                  [
                    "...",
                    "Scan"
                  ],
                  [
                    "...",
                    "DeleteItem"
                  ]
                ],
                "region": "${BaseRegion}",
                "stat": "Average",
                "title": "Dynamo Latency"
              }
            },
            {
              "type": "metric",
              "x": 6,
              "y": 18,
              "width": 6,
              "height": 6,
              "start": "-P3D",
              "properties": {
                "view": "timeSeries",
                "stacked": false,
                "metrics": [
                  [
                    "AWS/DynamoDB",
                    "SuccessfulRequestLatency",
                    "TableName",
                    "${TableName}",
                    "Operation",
                    "BatchWriteItem"
                  ],
                  [
                    "...",
                    "PutItem"
                  ],
                  [
                    "...",
                    "GetItem"
                  ],
                  [
                    "...",
                    "BatchGetItem"
                  ],
                  [
                    "...",
                    "Query"
                  ],
                  [
                    "...",
                    "Scan"
                  ],
                  [
                    "...",
                    "DeleteItem"
                  ]
                ],
                "region": "${BaseRegion}",
                "stat": "SampleCount",
                "title": "Dynamo Requests"
              }
            }
          ]
        }
      DashboardName: "heart-app"
